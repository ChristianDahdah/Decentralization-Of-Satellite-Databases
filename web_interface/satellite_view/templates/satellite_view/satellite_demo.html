<!DOCTYPE html>
<html lang="fr">
<head>
    <title>{% block title %} Satellite Demo {% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% load static %}
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="{% static "web3.min.js" %}"></script>
    <script src="{% static "satDetails_abi.js" %}" %}></script>
    <script src="{% static "oracle_abi.js" %}" %}></script>
    <script src="{% static "search_satellite_databases.js" %}" %}></script>
    {# <script src="{% static "get_block_number.js" %}" %}></script> #}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    {% block meta %} {% endblock %}

    <style>

	.blockNumber{
		position: absolute;
		left: 91px;
		transform: translate(-50%, 0%);
	}

        .leftBlock, .middleBlock, .rightBlock{
          position: relative;
          left: var(--leftshift);
        }
	
	.rightBlock{
	  opacity: 0;
	}

	:root{
	  --leftshift: calc(50% - 652px);
	}
	
	.middleBlockAnimation  {
	  animation: right-to-left 2.5s ease-in-out forwards;
	  animation-delay: 0s;
	  animation-play-state: running;
	}
	
	.leftBlockAnimation {
          animation: right-to-left-hide 2.5s ease-in-out forwards;
          animation-delay: 0s;
	  animation-play-state: running;
	}

	.rightBlockAnimation {
          animation:  pop-up 2.5s ease-in-out forwards;
          animation-delay: 0s;
	  animation-play-state: running;
	}
	
        @keyframes right-to-left {
          0% {
            left: var(--leftshift);
          }

          33% {
            left: var(--leftshift);
          }

          100% {
            left: calc(var(--leftshift) - 163px);
          }
        }

	@keyframes right-to-left-hide {
	  0% {
	    left: var(--leftshift);
	    opacity: 100;
	  }

          33% {
            left: var(--leftshift);
            opacity: 100;
          }

	  
	  100% {
	    left: calc(var(--leftshift) - 163px);
	    opacity: 0;
	  }
	}
	
	@keyframes pop-up {
	  0% {
	    left: var(--leftshift);
	    opacity: 0;
	  }

	  33% {
	    left: var(--leftshift);
	    opacity: 100;
	  }
	  100% {
            left: calc(var(--leftshift) - 163px);
	    opacity: 100;
	  }

	}

	img.block {
		width: 130px;
		height: 90px;
	}

	img.chain {
		width: 24px;
		height: 12px;
	}

	img.logo_cnes {
		width: 40px;
		height: 25px;
	}

        img.logo_nasa {
                width: 40px;
                height: 20px;
        }

	img.logo_roscosmos {
                width: 45px;
                height: 20px;
        }


    </style>


</head>


<body>


<div class="container-fluid p-3 my-1 bg-primary text-white text-center">

    <h2>Decentralized Satellite Database</h2>
    <h5>A blockchain solution for a trustless traceable consensus</h5>

</div>

</br>


<div class="row">


	<div class="col" name="left side">
		<div>
			{% csrf_token %}
			<input type="text" id="satellite_id" name="satellite_id" placeholder="Satellite Id"/>
			<button type="button" id="search_databases" class="btn btn-primary">Search</button>
		</div>
		
		</br>
		

		<table class="table table-hover", id="satellite_databases">
			<thead class="thead-dark">
			<tr>
				<th>Database</th>
				<th>Name</th>
				<th>Country</th>
				<th>Apogee</th>
				<th>Perigee</th>
				<th>Inclination</th>
				<th>Launch Date</th>

			{% for database, details in sat_details.items %}

				<tr>
					{% if database == "honest_node_1" %}
					<td> <img class="logo_cnes" src="https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2009/02/cnes_logo/9496749-4-eng-GB/CNES_Logo_pillars.jpg" alt="CNES"> </td>
					{% elif database == "honest_node_2" %}
					<td> <img class="logo_nasa" src="https://www.nasa.gov/sites/default/files/thumbnails/image/s75-31690.jpeg" alt="NASA"> </td>
					{% elif database == "honest_node_3" %}
					<td> <img class="logo_roscosmos" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Roscosmos_logo_en.svg/1280px-Roscosmos_logo_en.svg.png" alt="ROSCOSMOS"></td>
					{% elif database == "bad_node_1" %}
						<td style="color: red"> Bad node  </td>
					{% endif %}

					
					{% for key, value in details.items %}

						<td> {{ value }} </td>

					{% empty %}
					
						<td></td>
					
					{% endfor %}

				</tr>

			{% empty %}
			{% endfor %}

		</thead>
	    </table>
	</div>


	<div class="col" name="right side">


        </div>



</div>

</br>

<div id="Blockchain animation">
	
	<span class="leftBlock" style="display: inline-block">
	    <img src="https://www.nicepng.com/png/detail/51-512944_chain-link-icon-chain-link-png.png" class="chain" alt="chain">
	    <div style="display: inline">
	    	<img src="https://neironix.io/assets/thumbnails/b8/b8fdcdf85d401bb835b0406e4ce06795.png" class="block" alt="block">
			<p class="blockNumber", id="blockn-4"> # </p>
	    </div> 
	</span>

	<span class="middleBlock">
	    <img src="https://www.nicepng.com/png/detail/51-512944_chain-link-icon-chain-link-png.png" class="chain" alt="chain">
            <div style="display: inline">
                <img src="https://neironix.io/assets/thumbnails/b8/b8fdcdf85d401bb835b0406e4ce06795.png" class="block" alt="block">
                <p class="blockNumber", id="blockn-3"> # </p>
            </div>
	</span>


	<span class="middleBlock">
	    <img src="https://www.nicepng.com/png/detail/51-512944_chain-link-icon-chain-link-png.png" class="chain" alt="chain"> 
            <div style="display: inline">
                <img src="https://neironix.io/assets/thumbnails/b8/b8fdcdf85d401bb835b0406e4ce06795.png" class="block" alt="block">
                <p class="blockNumber", id="blockn-2"> # </p>
            </div>
	</span>

	<span class="middleBlock">
	    <img src="https://www.nicepng.com/png/detail/51-512944_chain-link-icon-chain-link-png.png" class="chain" alt="chain">
            <div style="display: inline">
                <img src="https://neironix.io/assets/thumbnails/b8/b8fdcdf85d401bb835b0406e4ce06795.png" class="block" alt="block">
                <p class="blockNumber", id="blockn-1"> # </p>
            </div>
	</span>

	<span class="rightBlock">
	    <img src="https://www.nicepng.com/png/detail/51-512944_chain-link-icon-chain-link-png.png" class="chain" alt="chain">
	            <div style="display: inline">
                <img src="https://neironix.io/assets/thumbnails/b8/b8fdcdf85d401bb835b0406e4ce06795.png" class="block" alt="block">
                <p class="blockNumber", id="blockn"> # </p>
            </div>
	</span>

</div>



<script>

var satDetails;
var userAccount;
var currentBlock;
var lastUpdatedBlock = 0;


window.addEventListener('animationend', () => {
        $('.leftBlock').removeClass('leftBlockAnimation');
        $('.middleBlock').removeClass('middleBlockAnimation');
        $('.rightBlock').removeClass('rightBlockAnimation');

	$('#blockn').html(currentBlock+1);
        $('#blockn-1').html(currentBlock);
        $('#blockn-2').html(currentBlock-1);
        $('#blockn-3').html(currentBlock-2);
        $('#blockn-4').html(currentBlock-3);

});


function startBlockAnimation(){

	$('#blockn').html(currentBlock);
        $('#blockn-1').html(currentBlock-1);
        $('#blockn-2').html(currentBlock-2);
        $('#blockn-3').html(currentBlock-3);
        $('#blockn-4').html(currentBlock-4);
	
	$('.leftBlock').addClass('leftBlockAnimation');
        $('.middleBlock').addClass('middleBlockAnimation');
        $('.rightBlock').addClass('rightBlockAnimation');


}

function startApp() {
	satDetails = new web3js.eth.Contract(satDetailsABI, '{{ satDetails_address }}');
	oracle = new web3js.eth.Contract(oracleABI, '{{ oracle_address }}');

	setInterval(function() {
  	// Check if account has changed
		web3Infura.eth.getBlockNumber().then((data) => {
			// $('#block_number').html(data);
			currentBlock = Number(data);
			if (lastUpdatedBlock != currentBlock){
				lastUpdatedBlock = currentBlock;
				 startBlockAnimation();
			}
		}) ;
	}, 1500);

}


async function onInit() {
        await window.ethereum.enable();
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        console.log(account)
         window.ethereum.on('accountsChanged', function (accounts) {
            // Time to reload your interface with accounts[0]!
            console.log(accounts[0])
           });
    }


window.addEventListener('load', function() {

  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
    web3js = new Web3(web3.currentProvider);
    web3Infura = new Web3(
    // Replace YOUR-PROJECT-ID with a Project ID from your Infura Dashboard
	    new Web3.providers.WebsocketProvider("{{ infura_url }}")
);
  } else {
    // Handle the case where the user doesn't have web3. Probably
    // show them a message telling them to install Metamask in
    // order to use our app.
	  alert("INSTALL METAMASK IN ORDER TO SEND TRANSACTIONS");
  }

  // Now you can start your app & access web3js freely:
  onInit();
  startApp();

})

</script>


</body>

